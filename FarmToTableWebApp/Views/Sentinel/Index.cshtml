@model FarmToTableWebApp.ViewModels.Sentinels.SentinelIndexViewModel
@{
    ViewData["Title"] = "Pending Analysis";
}
@using FarmToTableData.Models
<h1>
    Sentinels
</h1>
<div class="card card-body">
    <div class="d-flex justify-content-end">
        <button id="btn-refresh" type="button" class="btn btn-outline-dark btn-sm" style="display: none;">
            New Pending Analysis
            <span id="btn-refresh-content" class="badge bg-danger">
                0
            </span>
        </button>
    </div>    
    <table id="tbl-analysis" class="table table-striped table-sm w-100 table-hover"></table>
</div>

@section Scripts {    
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script type="text/javascript">
        'use strict';
        (() => {
            const connection = new signalR.HubConnectionBuilder().withUrl("/analysisHub").build();      
            const $tblAnalysis = $('#tbl-analysis');
            const $btnRefresh = $('#btn-refresh');
            const $btnRefreshContent = $('#btn-refresh-content');
            const tables = {};
            const routePrefix = '/Sentinel';
            const routes = {
                analysisTableJson: `${routePrefix}/AnalysisTableJson`
            }

            let analysisCount = 0;

            const analysis = {
                showHideCounter: () => {
                    if (analysisCount > 0){
                        $btnRefresh.show();                        
                    } else {
                        $btnRefresh.hide();
                    }
                    $btnRefreshContent.text(analysisCount);
                },
                getTemperatureData: (temp) => {
                    return `
                        <span class='badge bg-warning'>Temperature ${temp.TemperatureCelsius}&deg;C</span>
                    `;
                },
                getMoistureData: (moisture) => {
                    return `
                        <span class='badge bg-primary'>Moisture ${moisture.Moisture}/10</span>
                    `;
                },
                getSoilData: (soil) => {
                    return `
                        <span class='badge bg-dark'>Soil (N:${soil.NPpm}, P:${soil.PPpm}, K:${soil.KPpm})</span>
                    `;
                },
                getSentinelStatusData: (ssData) => {
                    const bg = ssData.SentinelStatusCode === @((int)ESentinelStatus.Offline)
                        ? 'bg-danger'
                        : 'bg-success';
                    return `
                        <span class='badge ${bg}'>Status ${ssData.SentinelStatusCode}</span>
                    `;
                },
                getDataRow: (obj) => {
                    const divs = [];
                    $.each(Object.keys(obj), function(index, key) {
                        let fn;
                        const type = obj[key].EventType;
                        if (type === @((int)EEventType.Temperature)) {
                            fn = analysis.getTemperatureData;
                        } else if (type === @((int)EEventType.Moisture)) {
                            fn = analysis.getMoistureData;
                        } else if (type === @((int)EEventType.Soil)) {
                            fn = analysis.getSoilData;
                        } else if (type === @((int)EEventType.SentinelStatus)) {
                            fn = analysis.getSentinelStatusData;
                        }
                        const div = fn(obj[key]);
                        divs.push(div);
                    });
                    return divs.join('</br>');
                },
                loadTable: () => {
                    if (!tables['analysis']) {
                        tables['analysis'] = $tblAnalysis
                            .DataTable({
                                processing: true,
                                ajax: {
                                    url: routes.analysisTableJson
                                },
                                columns: @Html.Raw(Model.ColDefs_SentinelsPendingAnalysis),
                                columnDefs: [
                                    {
                                        targets: [0, 1, 2],
                                        render: function(data, type, row, meta) {
                                            if (type === 'display') {
                                                return data;
                                            }
                                            return data;
                                        }
                                    },
                                    {
                                        targets: [3], // saved date
                                        render: function(data, type, row, meta) {
                                            if (type === 'display') {
                                                console.log(data);
                                                return moment(data).format('M/D/YYYY h:m:s.SSS a');
                                            }
                                            return data;
                                        }
                                    },
                                    {
                                        targets: [4], // data
                                        render: function(data, type, row, meta) {
                                            if (type === 'display') {
                                                return analysis.getDataRow(data);
                                            }
                                            return data;
                                        }
                                    }
                                ],
                                order: [[1, 'asc']]
                            });
                    } else {
                        tables['analysis'].ajax.reload();
                    }
                }
            }


            connection
                .on('ReceiveNewPendingAnalysis', (type, model) => {
                    //analysisCount++;
                    //analysis.showHideCounter();
                    //toastr.success(`Received new pending analysis with data: ${model}.`);
                    analysis.loadTable();
                });

            connection.start().then(() => {
                console.log('signalR started...');
            }).catch((err) => {
                return console.error(err.toString());
            });

            $btnRefresh
                .on('click', function() {
                    analysisCount = 0;
                    analysis.loadTable();
                    analysis.showHideCounter();
                });

            analysis.loadTable();
        })();
    </script>
}
